name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–¥–∞ –¢—Ä–µ–±—ã –û–Ω–ª–∞–π–Ω

on:
  schedule:
    - cron: '0 21 * * *'  # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 01:00 UTC
  workflow_dispatch:

jobs:
  generate-feed:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–∞—Ä—Å–µ—Ä–∞
        run: |
          python3 feed-treba.py

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–∑–¥–∞–Ω –ª–∏ —Ñ–∏–¥
        run: |
          if [ -f "output_treba/treba_catalog.xml" ]; then
            echo "‚úÖ –§–∏–¥ —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä: $(wc -c < output_treba/treba_catalog.xml) –±–∞–π—Ç"
            echo "   –¢–æ–≤–∞—Ä–æ–≤ –≤ —Ñ–∏–¥–µ:"
            grep -c '<offer' output_treba/treba_catalog.xml || echo "0"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∏–¥ –Ω–µ —Å–æ–∑–¥–∞–Ω"
            ls -la output_treba/ || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            exit 1
          fi

      - name: üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ñ–∏–¥
          if git diff --quiet output_treba/treba_catalog.xml; then
            echo "‚ÑπÔ∏è –§–∏–¥ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –∫–æ–º–º–∏—Ç –Ω–µ –Ω—É–∂–µ–Ω"
            exit 0
          fi

          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
          git add output_treba/treba_catalog.xml
          git add output_treba/treba_catalog.xml.backup || true
          git add output_treba/progress.json

          # –ö–æ–º–º–∏—Ç–∏–º —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
          git commit -m "üîÑ –û–±–Ω–æ–≤–ª—ë–Ω —Ñ–∏–¥ –¢—Ä–µ–±—ã –û–Ω–ª–∞–π–Ω: $(date '+%Y-%m-%d %H:%M:%S')"
          git push

          echo "‚úÖ –§–∏–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ GitHub"
